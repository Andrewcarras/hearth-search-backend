<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hearth - Find Your Dream Home</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            min-height: 100vh;
            color: #333;
        }

        .hero {
            text-align: center;
            padding: 60px 20px 40px;
            color: white;
        }

        .logo {
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: -1px;
        }

        .tagline {
            font-size: 1.2em;
            opacity: 0.95;
            font-weight: 300;
            margin-bottom: 15px;
        }

        .example-queries {
            text-align: center;
            margin-top: 20px;
            color: white;
        }

        .example-queries-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .example-query-chips {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            max-width: 900px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .example-chip {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
            white-space: nowrap;
            overflow: visible;
        }

        .example-chip:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .search-container {
            max-width: 800px;
            margin: 0 auto 40px;
            padding: 0 20px;
        }

        .search-box {
            position: relative;
            background: white;
            border-radius: 50px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex;
            align-items: stretch;
            transition: all 0.3s ease;
        }

        .search-box:focus-within {
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }

        .search-icon {
            padding: 0 20px 0 25px;
            color: #10b981;
            font-size: 24px;
        }

        .search-input {
            flex: 1;
            border: none;
            padding: 22px 30px;
            font-size: 18px;
            outline: none;
            background: transparent;
            border-radius: 50px 0 0 50px;
        }

        .search-input::placeholder {
            color: #aaa;
        }

        .search-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 22px 40px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            border-radius: 0 50px 50px 0;
            flex-shrink: 0;
        }

        .search-button:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .search-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .filters-container {
            max-width: 1200px;
            margin: 20px auto 0;
            padding: 0 20px;
        }

        .filters-box {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .filters-title {
            color: white;
            font-size: 1em;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        @media (max-width: 1024px) {
            .filters-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .filters-grid {
                grid-template-columns: 1fr;
            }
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .filter-label {
            color: white;
            font-size: 0.85em;
            margin-bottom: 8px;
            opacity: 0.95;
            font-weight: 500;
        }

        .filter-input {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px 12px;
            color: white;
            font-size: 0.9em;
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .filter-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .filter-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .filter-range {
            display: flex;
            gap: 8px;
            align-items: center;
            width: 100%;
        }

        .filter-range-input {
            flex: 1;
            min-width: 0;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px 8px;
            color: white;
            font-size: 0.85em;
            box-sizing: border-box;
        }

        .filter-range-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .filter-range-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .filter-range-separator {
            color: white;
            opacity: 0.8;
            flex-shrink: 0;
        }

        .clear-filters-btn {
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s ease;
            width: 100%;
        }

        .clear-filters-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px 60px;
        }

        .results-header {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .properties-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 30px;
        }

        .property-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .property-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 40px rgba(0,0,0,0.25);
        }

        .property-image {
            width: 100%;
            height: 240px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .property-content {
            padding: 20px;
        }

        .property-price {
            font-size: 1.8em;
            font-weight: 700;
            color: #10b981;
            margin-bottom: 10px;
        }

        .property-address {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .property-location {
            font-size: 0.95em;
            color: #777;
            margin-bottom: 15px;
        }

        .property-stats {
            display: flex;
            gap: 20px;
            padding: 15px 0;
            border-top: 1px solid #eee;
            font-size: 0.95em;
            color: #555;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-icon {
            font-weight: 600;
        }

        .property-score {
            display: inline-block;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 10px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: #fff;
            margin: 3% auto;
            max-width: 1100px;
            border-radius: 20px;
            overflow: hidden;
            animation: slideIn 0.4s;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 25px 35px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 2em;
            font-weight: 600;
        }

        .close {
            color: white;
            font-size: 36px;
            font-weight: 300;
            cursor: pointer;
            line-height: 1;
            transition: opacity 0.2s;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Image Gallery */
        .image-gallery {
            position: relative;
            background: #000;
        }

        .gallery-main {
            width: 100%;
            height: 500px;
            object-fit: contain;
            background: #000;
        }

        .gallery-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            font-size: 36px;
            padding: 25px 18px;
            cursor: pointer;
            transition: background 0.3s;
            border-radius: 0;
        }

        .gallery-nav:hover {
            background: rgba(0,0,0,0.8);
        }

        .gallery-prev { left: 0; }
        .gallery-next { right: 0; }

        .gallery-counter {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 500;
        }

        .gallery-thumbnails {
            display: flex;
            gap: 10px;
            padding: 20px;
            background: #f7f8fa;
            overflow-x: auto;
        }

        .gallery-thumb {
            width: 90px;
            height: 70px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .gallery-thumb:hover {
            border-color: #10b981;
            transform: scale(1.05);
        }

        .gallery-thumb.active {
            border-color: #10b981;
        }

        .detail-section {
            padding: 35px;
        }

        .detail-section h3 {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .detail-item {
            background: #f7f8fa;
            padding: 18px;
            border-radius: 10px;
        }

        .detail-label {
            font-size: 13px;
            color: #777;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .detail-value {
            font-size: 1.3em;
            color: #333;
            font-weight: 600;
        }

        .description {
            background: #f7f8fa;
            padding: 25px;
            border-radius: 10px;
            line-height: 1.7;
            color: #555;
            font-size: 1.05em;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: white;
        }

        .no-results-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.7;
        }

        .no-results h3 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .no-results p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        /* Feedback Section Styles */
        .feedback-section {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .feedback-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .feedback-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 600;
        }

        .feedback-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .feedback-btn.thumbs-up:hover,
        .feedback-btn.thumbs-up.selected {
            border-color: #4CAF50;
            background: #f1f8f4;
        }

        .feedback-btn.thumbs-down:hover,
        .feedback-btn.thumbs-down.selected {
            border-color: #f44336;
            background: #fef1f0;
        }

        .feedback-btn.selected {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .feedback-details {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }

        .feedback-categories {
            margin-bottom: 15px;
        }

        .category-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            cursor: pointer;
            font-size: 0.95em;
        }

        .category-checkbox input[type="checkbox"] {
            cursor: pointer;
        }

        .feedback-submit-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .feedback-submit-btn {
            flex: 1;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .feedback-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
            background: #45a049;
        }

        .feedback-skip-btn {
            flex: 1;
            background: white;
            color: #666;
            border: 1px solid #ddd;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .feedback-skip-btn:hover {
            background: #f5f5f5;
        }

        .feedback-success,
        .feedback-already-submitted {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background: #f1f8f4;
            border: 2px solid #4CAF50;
            border-radius: 12px;
            color: #2e7d32;
            font-weight: 600;
        }

        .feedback-already-submitted {
            background: #e3f2fd;
            border-color: #2196F3;
            color: #1565c0;
        }

        /* Bug Report Button */
        .bug-report-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: white;
            color: #4CAF50;
            border: 2px solid #4CAF50;
            border-radius: 30px;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .bug-report-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
            background: #f1f8f4;
        }

        /* Search Quality Feedback Button */
        .search-feedback-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: white;
            color: #4CAF50;
            border: 2px solid #4CAF50;
            border-radius: 30px;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .search-feedback-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
            background: #f1f8f4;
        }

        /* Search Quality Modal */
        .search-quality-modal-content {
            max-width: 480px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .search-quality-header {
            padding: 30px 30px 20px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }

        .search-quality-header h3 {
            font-size: 24px;
            color: #333;
            margin-bottom: 8px;
        }

        .search-quality-header p {
            color: #666;
            font-size: 14px;
        }

        .search-quality-body {
            padding: 30px;
        }

        .star-rating {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 25px;
        }

        .star {
            font-size: 40px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #ddd;
        }

        .star:hover,
        .star.active {
            color: #FFA500;
            transform: scale(1.1);
        }

        .search-quality-details {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid #f0f0f0;
            display: none;
        }

        .search-quality-details.visible {
            display: block;
        }

        .quality-issue-categories {
            margin-bottom: 20px;
        }

        .quality-issue-categories label {
            font-weight: 600;
            display: block;
            margin-bottom: 12px;
            color: #333;
        }

        .quality-issue-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .quality-category-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quality-category-checkbox:hover {
            background: #e9ecef;
        }

        .quality-category-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .quality-feedback-text {
            width: 100%;
            height: 90px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.2s ease;
        }

        .quality-feedback-text:focus {
            outline: none;
            border-color: #10b981;
        }

        .search-quality-buttons {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }

        .search-quality-submit {
            flex: 1;
            background: #10b981;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-quality-submit:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .search-quality-skip {
            flex: 1;
            background: white;
            color: #666;
            border: 2px solid #e0e0e0;
            padding: 14px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-quality-skip:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .search-quality-success {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 30px;
            color: #10b981;
            font-size: 18px;
            font-weight: 600;
        }

        .search-quality-success.visible {
            display: flex;
        }

        .bug-report-modal-content {
            max-width: 600px;
        }

        .issue-type-radio {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .issue-type-radio:hover {
            background: #f5f5f5;
        }

        .issue-type-radio input[type="radio"] {
            cursor: pointer;
        }

        /* Search History Styles */
        .search-history-container {
            max-width: 800px;
            margin: 10px auto 20px;
            padding: 0 20px;
        }

        .search-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px 8px 0 0;
            color: white;
            font-weight: 600;
        }

        .clear-history-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }

        .clear-history-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .search-history-list {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .search-history-item {
            padding: 12px 15px;
            color: white;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.2s ease;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .search-history-item:last-child {
            border-bottom: none;
        }

        .search-history-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .search-history-item-icon {
            opacity: 0.7;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .search-history-item-text {
            flex: 1;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            line-height: 1.4;
        }

        /* Clear History Confirmation Modal */
        .clear-history-modal-content {
            max-width: 450px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .clear-history-modal-body {
            padding: 30px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .logo { font-size: 2.2em; }
            .tagline { font-size: 1em; }
            .search-input { font-size: 16px; padding: 18px 10px; }
            .search-button { padding: 18px 25px; font-size: 14px; }
            .properties-grid { grid-template-columns: 1fr; gap: 20px; }
            .gallery-main { height: 300px; }
            .detail-section { padding: 20px; }
            .feedback-buttons { flex-direction: column; }
            .bug-report-button { bottom: 10px; left: 10px; font-size: 14px; padding: 10px 16px; }
            .search-feedback-button { bottom: 10px; right: 10px; font-size: 14px; padding: 10px 16px; }
            .search-quality-modal-content { max-width: 90vw; margin: 20px; }
            .quality-issue-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="hero">
        <h1 class="logo">Hearth</h1>
        <p class="tagline">Find your perfect home with AI-powered search</p>

        <div class="search-container">
            <div class="search-box">
                <input
                    type="text"
                    class="search-input"
                    id="searchQuery"
                    placeholder="Describe your dream home..."
                    onkeypress="if(event.key === 'Enter') performSearch()"
                >
                <button class="search-button" onclick="performSearch()">Search</button>
            </div>

            <!-- Search History Dropdown -->
            <div id="searchHistoryContainer" class="search-history-container" style="display: none;">
                <div class="search-history-header">
                    <span>Recent Searches</span>
                    <button class="clear-history-btn" onclick="clearSearchHistory()">Clear All</button>
                </div>
                <div id="searchHistoryList" class="search-history-list"></div>
            </div>

            <div class="example-queries">
                <div class="example-queries-label">Try these examples:</div>
                <div class="example-query-chips">
                    <div class="example-chip" onclick="fillExample('White homes with granite countertops and wood floors')">White homes with granite & wood floors</div>
                    <div class="example-chip" onclick="fillExample('Modern homes with pool and chef kitchen')">Modern homes with pool</div>
                    <div class="example-chip" onclick="fillExample('Brick exterior homes with hardwood floors')">Brick homes with hardwood</div>
                    <div class="example-chip" onclick="fillExample('Houses with a front porch and a pool')">Front porch with pool</div>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-container">
            <div class="filters-box">
                <div class="filters-title">Refine Your Search</div>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">Price Range</label>
                        <div class="filter-range">
                            <input type="number" id="priceMin" class="filter-range-input" placeholder="Min" oninput="applyFiltersToResults()">
                            <span class="filter-range-separator">-</span>
                            <input type="number" id="priceMax" class="filter-range-input" placeholder="Max" oninput="applyFiltersToResults()">
                        </div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Bedrooms</label>
                        <div class="filter-range">
                            <input type="number" id="bedsMin" class="filter-range-input" placeholder="Min" min="0" oninput="applyFiltersToResults()">
                            <span class="filter-range-separator">-</span>
                            <input type="number" id="bedsMax" class="filter-range-input" placeholder="Max" min="0" oninput="applyFiltersToResults()">
                        </div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Bathrooms</label>
                        <div class="filter-range">
                            <input type="number" id="bathsMin" class="filter-range-input" placeholder="Min" min="0" step="0.5" oninput="applyFiltersToResults()">
                            <span class="filter-range-separator">-</span>
                            <input type="number" id="bathsMax" class="filter-range-input" placeholder="Max" min="0" step="0.5" oninput="applyFiltersToResults()">
                        </div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Square Feet</label>
                        <div class="filter-range">
                            <input type="number" id="sqftMin" class="filter-range-input" placeholder="Min" oninput="applyFiltersToResults()">
                            <span class="filter-range-separator">-</span>
                            <input type="number" id="sqftMax" class="filter-range-input" placeholder="Max" oninput="applyFiltersToResults()">
                        </div>
                    </div>
                </div>
                <button class="clear-filters-btn" onclick="clearFilters()">Clear Filters</button>
            </div>
        </div>
    </div>

    <div id="loadingIndicator" class="loading" style="display: none;">
        <div class="spinner"></div>
        <div>Searching for your dream home...</div>
    </div>

    <div id="resultsContainer" class="results-container" style="display: none;">
        <div class="results-header">
            <span id="resultsCount"></span>
        </div>
        <div class="properties-grid" id="propertiesGrid"></div>
    </div>

    <div id="noResults" class="no-results" style="display: none;">
        <div class="no-results-icon">üè†</div>
        <h3>No properties found</h3>
        <p>Try adjusting your search criteria</p>
    </div>

    <!-- Property Detail Modal -->
    <div id="propertyModal" class="modal" onclick="if(event.target === this) closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalAddress"></h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="image-gallery">
                    <img id="galleryImage" class="gallery-main" src="" alt="Property">
                    <button class="gallery-nav gallery-prev" onclick="changeImage(-1)">&#10094;</button>
                    <button class="gallery-nav gallery-next" onclick="changeImage(1)">&#10095;</button>
                    <div class="gallery-counter">
                        <span id="imageCounter"></span>
                    </div>
                </div>
                <div class="gallery-thumbnails" id="thumbnails"></div>

                <div class="detail-section">
                    <h3>Property Details</h3>
                    <div class="detail-grid" id="detailsGrid"></div>

                    <h3 style="margin-top: 30px;">Description</h3>
                    <div class="description" id="propertyDescription"></div>

                    <!-- Feedback Section -->
                    <div class="feedback-section" id="feedbackSection">
                        <h3 style="margin-top: 30px;">How well does this match your search?</h3>
                        <p style="color: #666; font-size: 0.9em; margin-bottom: 20px;">Your feedback helps us improve search results</p>

                        <div class="feedback-buttons">
                            <button class="feedback-btn thumbs-up" onclick="setFeedbackRating('up')">
                                <span style="font-size: 24px;">üëç</span>
                                <span>Good Match</span>
                            </button>
                            <button class="feedback-btn thumbs-down" onclick="setFeedbackRating('down')">
                                <span style="font-size: 24px;">üëé</span>
                                <span>Poor Match</span>
                            </button>
                        </div>

                        <div id="feedbackDetails" class="feedback-details" style="display: none;">
                            <div id="feedbackCategoriesSection" class="feedback-categories">
                                <label style="font-weight: 600; display: block; margin-bottom: 10px;">What's the issue? (optional)</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <label class="category-checkbox">
                                        <input type="checkbox" name="feedbackCategory" value="missing_features">
                                        Missing features
                                    </label>
                                    <label class="category-checkbox">
                                        <input type="checkbox" name="feedbackCategory" value="wrong_style">
                                        Wrong style
                                    </label>
                                    <label class="category-checkbox">
                                        <input type="checkbox" name="feedbackCategory" value="price_issue">
                                        Price issue
                                    </label>
                                    <label class="category-checkbox">
                                        <input type="checkbox" name="feedbackCategory" value="location_issue">
                                        Location issue
                                    </label>
                                    <label class="category-checkbox">
                                        <input type="checkbox" name="feedbackCategory" value="poor_quality">
                                        Poor quality
                                    </label>
                                    <label class="category-checkbox">
                                        <input type="checkbox" name="feedbackCategory" value="other">
                                        Other
                                    </label>
                                </div>
                            </div>

                            <div style="margin-top: 15px;">
                                <label style="font-weight: 600; display: block; margin-bottom: 8px;">Additional comments (optional)</label>
                                <textarea id="feedbackText" placeholder="Tell us more about why this is a good/poor match..." maxlength="1000" style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
                                <div style="text-align: right; font-size: 0.85em; color: #999; margin-top: 5px;">
                                    <span id="feedbackCharCount">0</span> / 1000
                                </div>
                            </div>

                            <div class="feedback-submit-buttons">
                                <button class="feedback-submit-btn" onclick="submitFeedback()">Submit Feedback</button>
                                <button class="feedback-skip-btn" onclick="skipFeedback()">Skip</button>
                            </div>
                        </div>

                        <div id="feedbackSuccess" class="feedback-success" style="display: none;">
                            <span style="font-size: 24px;">‚úì</span>
                            <span>Thank you for your feedback!</span>
                        </div>

                        <div id="feedbackAlreadySubmitted" class="feedback-already-submitted" style="display: none;">
                            <span style="font-size: 20px;">‚ÑπÔ∏è</span>
                            <span>You've already provided feedback for this property</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bug Report Button (Fixed Position) -->
    <div id="bugReportButton" class="bug-report-button" onclick="openBugReportModal()">
        <span>Report Issue</span>
    </div>

    <!-- Search Quality Feedback Button (Fixed Position) -->
    <div id="searchFeedbackButton" class="search-feedback-button" style="visibility: hidden; opacity: 0;" onclick="openSearchQualityModal()">
        <span>Rate this search</span>
    </div>

    <!-- Search Quality Feedback Modal -->
    <div id="searchQualityModal" class="modal" onclick="if(event.target === this) closeSearchQualityModal()">
        <div class="modal-content search-quality-modal-content" onclick="event.stopPropagation()">
            <div class="search-quality-header">
                <h3>How would you rate this search?</h3>
                <p>Your feedback helps us improve search results</p>
            </div>

            <div class="search-quality-body">
                <!-- Star Rating -->
                <div class="star-rating" id="starRating">
                    <span class="star" data-rating="1" onclick="setSearchRating(1)">‚òÖ</span>
                    <span class="star" data-rating="2" onclick="setSearchRating(2)">‚òÖ</span>
                    <span class="star" data-rating="3" onclick="setSearchRating(3)">‚òÖ</span>
                    <span class="star" data-rating="4" onclick="setSearchRating(4)">‚òÖ</span>
                    <span class="star" data-rating="5" onclick="setSearchRating(5)">‚òÖ</span>
                </div>

                <!-- Issue Categories (shows for low ratings only) -->
                <div id="searchQualityIssues" class="search-quality-details">
                    <div class="quality-issue-categories">
                        <label>What could be improved? (optional)</label>
                        <div class="quality-issue-grid">
                            <label class="quality-category-checkbox">
                                <input type="checkbox" name="qualityCategory" value="not_relevant">
                                <span>Results not relevant</span>
                            </label>
                            <label class="quality-category-checkbox">
                                <input type="checkbox" name="qualityCategory" value="missing_properties">
                                <span>Missing key properties</span>
                            </label>
                            <label class="quality-category-checkbox">
                                <input type="checkbox" name="qualityCategory" value="poor_quality">
                                <span>Poor quality matches</span>
                            </label>
                            <label class="quality-category-checkbox">
                                <input type="checkbox" name="qualityCategory" value="wrong_price_location">
                                <span>Wrong price/location</span>
                            </label>
                            <label class="quality-category-checkbox">
                                <input type="checkbox" name="qualityCategory" value="too_few_results">
                                <span>Too few results</span>
                            </label>
                            <label class="quality-category-checkbox">
                                <input type="checkbox" name="qualityCategory" value="other">
                                <span>Other</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Comments Section (always visible after rating) -->
                <div id="searchQualityComments" style="display: none; margin-top: 25px; padding-top: 25px; border-top: 1px solid #f0f0f0;">
                    <div>
                        <label style="font-weight: 600; display: block; margin-bottom: 8px;">Additional comments (optional)</label>
                        <textarea id="searchQualityText" class="quality-feedback-text" placeholder="Tell us more about your experience with this search..." maxlength="1000"></textarea>
                        <div style="text-align: right; font-size: 0.85em; color: #999; margin-top: 5px;">
                            <span id="searchQualityCharCount">0</span> / 1000
                        </div>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="search-quality-buttons">
                    <button class="search-quality-submit" onclick="submitSearchQuality()">Submit</button>
                    <button class="search-quality-skip" onclick="closeSearchQualityModal()">Skip</button>
                </div>

                <!-- Success Message -->
                <div id="searchQualitySuccess" class="search-quality-success">
                    <span style="font-size: 28px;">‚úì</span>
                    <span>Thank you for your feedback!</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Bug Report Modal -->
    <div id="bugReportModal" class="modal" onclick="if(event.target === this) closeBugReportModal()">
        <div class="modal-content bug-report-modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>Report an Issue</h2>
                <span class="close" onclick="closeBugReportModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p style="color: #666; margin-bottom: 20px;">Help us improve by reporting bugs or issues you've encountered</p>

                <div style="margin-bottom: 20px;">
                    <label style="font-weight: 600; display: block; margin-bottom: 10px;">Issue Type</label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label class="issue-type-radio">
                            <input type="radio" name="issueType" value="search_error" checked>
                            Search not working or showing errors
                        </label>
                        <label class="issue-type-radio">
                            <input type="radio" name="issueType" value="wrong_results">
                            Search results don't match my query
                        </label>
                        <label class="issue-type-radio">
                            <input type="radio" name="issueType" value="ui_bug">
                            UI/Display issue
                        </label>
                        <label class="issue-type-radio">
                            <input type="radio" name="issueType" value="performance">
                            Slow performance
                        </label>
                        <label class="issue-type-radio">
                            <input type="radio" name="issueType" value="other">
                            Other
                        </label>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="font-weight: 600; display: block; margin-bottom: 8px;">Description <span style="color: red;">*</span></label>
                    <textarea id="bugDescription" placeholder="Please describe the issue you encountered..." maxlength="2000" style="width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
                    <div style="text-align: right; font-size: 0.85em; color: #999; margin-top: 5px;">
                        <span id="bugCharCount">0</span> / 2000
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="feedback-submit-btn" onclick="submitBugReport()">Submit Report</button>
                    <button class="feedback-skip-btn" onclick="closeBugReportModal()">Cancel</button>
                </div>

                <div id="bugReportSuccess" class="feedback-success" style="display: none; margin-top: 20px;">
                    <span style="font-size: 24px;">‚úì</span>
                    <span>Thank you! Your issue report has been submitted.</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Clear History Confirmation Modal -->
    <div id="clearHistoryModal" class="modal" onclick="if(event.target === this) closeClearHistoryModal()">
        <div class="modal-content clear-history-modal-content" onclick="event.stopPropagation()">
            <div class="clear-history-modal-body">
                <div style="font-size: 2em; margin-bottom: 15px;">üóëÔ∏è</div>
                <h3 style="margin-bottom: 10px; color: #333;">Clear Search History?</h3>
                <p style="color: #666; margin-bottom: 25px;">This will remove all your recent searches. This action cannot be undone.</p>
                <div style="display: flex; gap: 10px;">
                    <button class="feedback-submit-btn" onclick="confirmClearHistory()">Yes, Clear All</button>
                    <button class="feedback-skip-btn" onclick="closeClearHistoryModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_ENDPOINT = 'https://f2o144zh31.execute-api.us-east-1.amazonaws.com/search';
        const ANALYTICS_ENDPOINT = 'https://f2o144zh31.execute-api.us-east-1.amazonaws.com/production';

        let currentProperty = null;
        let currentImageIndex = 0;
        let allResults = [];  // Store all results for filtering

        // ===== ANALYTICS MODULE =====
        const Analytics = {
            sessionId: null,
            sessionStart: null,
            lastActivity: null,
            currentQueryId: null,
            searchHistory: [],
            capturedErrors: [],
            SESSION_TIMEOUT_MS: 30 * 60 * 1000, // 30 minutes

            init() {
                this.loadSession();
                this.setupErrorCapture();
                this.startActivityMonitoring();
                this.loadSearchHistory();

                // Send final data before page unload
                window.addEventListener('beforeunload', () => this.endSession());
            },

            loadSession() {
                const stored = localStorage.getItem('analytics_session');
                if (stored) {
                    const session = JSON.parse(stored);
                    const now = Date.now();

                    // Check if session expired (30 min inactive)
                    if (session.lastActivity && (now - session.lastActivity) < this.SESSION_TIMEOUT_MS) {
                        this.sessionId = session.sessionId;
                        this.sessionStart = session.sessionStart;
                        this.lastActivity = now;
                    }
                }

                // Create new session if needed
                if (!this.sessionId) {
                    this.sessionId = this.generateUUID();
                    this.sessionStart = Date.now();
                    this.lastActivity = Date.now();
                }

                this.saveSession();
            },

            saveSession() {
                localStorage.setItem('analytics_session', JSON.stringify({
                    sessionId: this.sessionId,
                    sessionStart: this.sessionStart,
                    lastActivity: this.lastActivity
                }));
            },

            updateActivity() {
                this.lastActivity = Date.now();
                this.saveSession();

                // Send heartbeat to backend every 5 minutes
                const timeSinceUpdate = Date.now() - this.lastActivity;
                if (timeSinceUpdate > 5 * 60 * 1000) {
                    this.sendUpdateSession();
                }
            },

            generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            },

            getDeviceInfo() {
                return {
                    user_agent: navigator.userAgent,
                    screen_resolution: `${screen.width}x${screen.height}`,
                    viewport_size: `${window.innerWidth}x${window.innerHeight}`,
                    device_type: this.detectDeviceType()
                };
            },

            detectDeviceType() {
                const ua = navigator.userAgent;
                if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) {
                    return 'tablet';
                }
                if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(ua)) {
                    return 'mobile';
                }
                return 'desktop';
            },

            setupErrorCapture() {
                window.addEventListener('error', (event) => {
                    this.capturedErrors.push({
                        message: event.message,
                        source: event.filename,
                        line: event.lineno,
                        column: event.colno,
                        timestamp: Date.now()
                    });
                    // Keep only last 10 errors
                    if (this.capturedErrors.length > 10) {
                        this.capturedErrors.shift();
                    }
                });

                window.addEventListener('unhandledrejection', (event) => {
                    this.capturedErrors.push({
                        message: String(event.reason),
                        timestamp: Date.now()
                    });
                });
            },

            startActivityMonitoring() {
                // Update activity on user interactions
                ['click', 'scroll', 'keypress'].forEach(event => {
                    document.addEventListener(event, () => this.updateActivity(), { passive: true });
                });
            },

            async logSearch(query, results, apiResponse) {
                this.updateActivity();

                const queryId = this.generateUUID();
                this.currentQueryId = queryId;

                // Add to search history
                this.addToSearchHistory(query);

                const searchLog = {
                    session_id: this.sessionId,
                    session_start: this.sessionStart,
                    search_query: query,
                    ...this.getDeviceInfo(),

                    // Results data
                    total_results: results.length,
                    results_zpids: results.map(r => r.zpid),
                    result_scores: results.map(r => r.score || 0),
                    top_5_zpids: results.slice(0, 5).map(r => r.zpid),

                    // Backend details from API response
                    sub_queries: apiResponse.sub_queries || [],
                    llm_success: apiResponse.llm_success || false,
                    fallback_used: apiResponse.fallback_used || false,
                    search_strategy: apiResponse.search_strategy || 'unknown',
                    execution_time_ms: apiResponse.execution_time_ms || 0,
                    adaptive_k_values: apiResponse.adaptive_k_values || {},
                    visual_ratio: apiResponse.visual_ratio || 0,
                    text_ratio: apiResponse.text_ratio || 0,
                    feature_context: apiResponse.feature_context || '',

                    // Filters
                    filters_applied: this.getCurrentFilters(),
                    filters_used: this.areFiltersUsed(),
                    filtered_count: results.length,

                    // Context
                    referrer: document.referrer,
                    search_sequence_number: this.searchHistory.length,
                    previous_query: this.searchHistory.length > 1 ? this.searchHistory[this.searchHistory.length - 2] : ''
                };

                try {
                    const response = await fetch(`${ANALYTICS_ENDPOINT}/log-search`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(searchLog)
                    });

                    if (!response.ok) {
                        console.error('Failed to log search:', await response.text());
                    }
                } catch (error) {
                    console.error('Error logging search:', error);
                }
            },

            getCurrentFilters() {
                return {
                    price_min: parseFloat(document.getElementById('priceMin')?.value) || 0,
                    price_max: parseFloat(document.getElementById('priceMax')?.value) || 0,
                    beds_min: parseFloat(document.getElementById('bedsMin')?.value) || 0,
                    beds_max: parseFloat(document.getElementById('bedsMax')?.value) || 0,
                    baths_min: parseFloat(document.getElementById('bathsMin')?.value) || 0,
                    baths_max: parseFloat(document.getElementById('bathsMax')?.value) || 0,
                    sqft_min: parseFloat(document.getElementById('sqftMin')?.value) || 0,
                    sqft_max: parseFloat(document.getElementById('sqftMax')?.value) || 0
                };
            },

            areFiltersUsed() {
                const filters = this.getCurrentFilters();
                return Object.values(filters).some(v => v > 0);
            },

            async submitFeedback(zpid, rating, text, categories, propertyData) {
                this.updateActivity();

                const feedback = {
                    session_id: this.sessionId,
                    session_start: this.sessionStart,
                    query_id: this.currentQueryId,
                    search_query: document.getElementById('searchQuery').value,

                    // Property details
                    zpid: zpid,
                    property_rank: propertyData.rank || 0,
                    property_score: propertyData.score || 0,
                    property_address: propertyData.address || '',
                    property_price: propertyData.price || 0,

                    // Feedback
                    rating: rating,
                    feedback_text: text,
                    feedback_categories: categories,

                    // Context
                    filters_active: this.getCurrentFilters(),
                    time_to_feedback: Date.now() - (propertyData.clickTime || Date.now()),

                    // Device
                    ...this.getDeviceInfo()
                };

                try {
                    const response = await fetch(`${ANALYTICS_ENDPOINT}/log-feedback`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(feedback)
                    });

                    if (response.ok) {
                        // Mark as submitted in localStorage
                        this.markFeedbackSubmitted(zpid);
                        return true;
                    } else {
                        console.error('Failed to submit feedback:', await response.text());
                        return false;
                    }
                } catch (error) {
                    console.error('Error submitting feedback:', error);
                    return false;
                }
            },

            markFeedbackSubmitted(zpid) {
                const submitted = JSON.parse(localStorage.getItem('feedback_submitted') || '[]');
                if (!submitted.includes(zpid)) {
                    submitted.push(zpid);
                    localStorage.setItem('feedback_submitted', JSON.stringify(submitted));
                }
            },

            hasFeedbackForProperty(zpid) {
                const submitted = JSON.parse(localStorage.getItem('feedback_submitted') || '[]');
                return submitted.includes(zpid);
            },

            async reportIssue(description, issueType) {
                this.updateActivity();

                const issue = {
                    session_id: this.sessionId,
                    session_start: this.sessionStart,
                    query_id: this.currentQueryId,

                    // Issue details
                    issue_type: issueType,
                    description: description,

                    // Context
                    current_url: window.location.href,
                    last_search_query: document.getElementById('searchQuery').value,
                    console_errors: this.capturedErrors,
                    browser_info: this.getDeviceInfo(),

                    // Device
                    ...this.getDeviceInfo()
                };

                try {
                    const response = await fetch(`${ANALYTICS_ENDPOINT}/report-issue`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(issue)
                    });

                    return response.ok;
                } catch (error) {
                    console.error('Error reporting issue:', error);
                    return false;
                }
            },

            async sendUpdateSession() {
                try {
                    await fetch(`${ANALYTICS_ENDPOINT}/update-session`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            session_start: this.sessionStart
                        })
                    });
                } catch (error) {
                    console.error('Error updating session:', error);
                }
            },

            endSession() {
                try {
                    const data = JSON.stringify({
                        session_id: this.sessionId,
                        session_start: this.sessionStart
                    });

                    // Use sendBeacon for reliability during page unload
                    if (navigator.sendBeacon) {
                        navigator.sendBeacon(`${ANALYTICS_ENDPOINT}/end-session`, data);
                    }
                } catch (error) {
                    console.error('Error ending session:', error);
                }
            },

            // Search History
            loadSearchHistory() {
                const stored = localStorage.getItem('search_history');
                if (stored) {
                    this.searchHistory = JSON.parse(stored);
                }
            },

            addToSearchHistory(query) {
                if (!this.searchHistory.includes(query)) {
                    this.searchHistory.push(query);

                    // Keep only last 10
                    if (this.searchHistory.length > 10) {
                        this.searchHistory.shift();
                    }

                    localStorage.setItem('search_history', JSON.stringify(this.searchHistory));
                    this.updateSearchHistoryUI();
                }
            },

            getSearchHistory() {
                return [...this.searchHistory].reverse(); // Most recent first
            },

            updateSearchHistoryUI() {
                // Trigger re-render if history is currently visible
                if (typeof renderSearchHistory === 'function') {
                    renderSearchHistory();
                }
            },

            clearSearchHistory() {
                this.searchHistory = [];
                localStorage.setItem('search_history', JSON.stringify([]));
                this.updateSearchHistoryUI();
            },

            hasFeedbackBeenSubmitted(zpid) {
                const submitted = JSON.parse(localStorage.getItem('feedback_submitted') || '[]');
                return submitted.includes(zpid);
            },

            async submitSearchQuality(rating, feedbackText, categories, propertiesViewed, timeOnResults) {
                this.updateActivity();

                const searchQuality = {
                    session_id: this.sessionId,
                    session_start: this.sessionStart,
                    query_id: this.currentQueryId,
                    search_query: document.getElementById('searchQuery').value,

                    // Rating and feedback
                    rating: rating,  // 1-5 stars
                    feedback_text: feedbackText,
                    feedback_categories: categories,

                    // Search context
                    total_results: window.currentResults ? window.currentResults.length : 0,
                    properties_viewed: propertiesViewed,
                    time_on_results: timeOnResults,
                    filters_active: this.getCurrentFilters(),

                    // Device
                    ...this.getDeviceInfo()
                };

                try {
                    const response = await fetch(`${ANALYTICS_ENDPOINT}/log-search-quality`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(searchQuality)
                    });

                    if (response.ok) {
                        console.log('Search quality feedback submitted successfully');
                        return true;
                    } else {
                        console.error('Failed to submit search quality:', await response.text());
                        return false;
                    }
                } catch (error) {
                    console.error('Error submitting search quality:', error);
                    return false;
                }
            }
        };

        // Initialize analytics on page load
        window.addEventListener('load', () => Analytics.init());

        // ===== END ANALYTICS MODULE =====

        function fillExample(query) {
            document.getElementById('searchQuery').value = query;
            document.getElementById('searchQuery').focus();
        }

        function applyFilters(results) {
            const priceMin = parseFloat(document.getElementById('priceMin').value) || 0;
            const priceMax = parseFloat(document.getElementById('priceMax').value) || Infinity;
            const bedsMin = parseFloat(document.getElementById('bedsMin').value) || 0;
            const bedsMax = parseFloat(document.getElementById('bedsMax').value) || Infinity;
            const bathsMin = parseFloat(document.getElementById('bathsMin').value) || 0;
            const bathsMax = parseFloat(document.getElementById('bathsMax').value) || Infinity;
            const sqftMin = parseFloat(document.getElementById('sqftMin').value) || 0;
            const sqftMax = parseFloat(document.getElementById('sqftMax').value) || Infinity;

            return results.filter(property => {
                const price = property.price || 0;
                const beds = property.bedrooms || 0;
                const baths = property.bathrooms || 0;
                const sqft = property.livingArea || 0;

                return price >= priceMin && price <= priceMax &&
                       beds >= bedsMin && beds <= bedsMax &&
                       baths >= bathsMin && baths <= bathsMax &&
                       sqft >= sqftMin && sqft <= sqftMax;
            });
        }

        function applyFiltersToResults() {
            if (allResults.length === 0) return;

            const query = document.getElementById('searchQuery').value.trim();
            displayResults(allResults, query);
        }

        function clearFilters() {
            document.getElementById('priceMin').value = '';
            document.getElementById('priceMax').value = '';
            document.getElementById('bedsMin').value = '';
            document.getElementById('bedsMax').value = '';
            document.getElementById('bathsMin').value = '';
            document.getElementById('bathsMax').value = '';
            document.getElementById('sqftMin').value = '';
            document.getElementById('sqftMax').value = '';
            applyFiltersToResults();
        }

        async function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) return;

            // Reset search quality feedback for new search
            searchQualitySubmitted = false;
            hideSearchFeedbackButton();

            // Show loading
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('noResults').style.display = 'none';

            try {
                // Use timestamp to prevent browser caching (avoids CORS preflight issues)
                const cacheBuster = Date.now();
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        q: query,
                        size: 20,
                        index: 'listings-v2',
                        use_multi_query: true,
                        _t: cacheBuster  // Cache buster timestamp
                    })
                });

                const data = await response.json();

                // Hide loading
                document.getElementById('loadingIndicator').style.display = 'none';

                if (data.results && data.results.length > 0) {
                    // Log search to analytics
                    await Analytics.logSearch(query, data.results, data);
                    displayResults(data.results, query);
                } else {
                    // Log search with zero results
                    await Analytics.logSearch(query, [], data);
                    document.getElementById('noResults').style.display = 'block';
                }
            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('noResults').style.display = 'block';
            }
        }

        function displayResults(results, query) {
            console.log('displayResults called with', results.length, 'results');
            const grid = document.getElementById('propertiesGrid');
            const resultsCount = document.getElementById('resultsCount');

            // Sort by score (highest to lowest) to ensure proper relevance ordering
            const sortedResults = [...results].sort((a, b) => (b.score || 0) - (a.score || 0));

            // Store all results for filtering
            allResults = sortedResults;

            // Apply filters
            const filtered = applyFilters(sortedResults);

            // Show total and filtered count
            if (filtered.length < sortedResults.length) {
                resultsCount.textContent = `Showing ${filtered.length} of ${sortedResults.length} properties matching "${query}"`;
            } else {
                resultsCount.textContent = `Found ${filtered.length} properties matching "${query}"`;
            }

            grid.innerHTML = '';

            if (filtered.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: white; opacity: 0.8;">No properties match the selected filters. Try adjusting your filter criteria.</div>';
            } else {
                filtered.forEach(property => {
                    const card = createPropertyCard(property);
                    grid.appendChild(card);
                });
            }

            document.getElementById('resultsContainer').style.display = 'block';
            document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth' });

            // Show search quality feedback button and track search start time
            window.searchStartTime = Date.now();
            window.currentResults = filtered;
            showSearchFeedbackButton();
        }

        function createPropertyCard(property) {
            const card = document.createElement('div');
            card.className = 'property-card';
            card.onclick = () => openPropertyModal(property);

            const imageUrl = property.images && property.images[0]
                ? property.images[0]
                : 'https://via.placeholder.com/400x300?text=No+Image';

            const price = property.price
                ? `$${property.price.toLocaleString()}`
                : 'Price N/A';

            const address = property.address?.streetAddress || 'Address N/A';
            const city = property.address?.city || property.city || '';
            const state = property.address?.state || property.state || '';
            const location = `${city}, ${state}`.trim().replace(/^,|,$/g, '') || 'Location N/A';

            const bedrooms = property.bedrooms || 'N/A';
            const bathrooms = property.bathrooms || 'N/A';
            const sqft = property.livingArea
                ? `${property.livingArea.toLocaleString()} sqft`
                : 'N/A';

            // Normalize score to 0-100 scale based on relative ranking
            // RRF scores are typically 0.05-0.15, so we scale them
            const score = property.score
                ? `Relevance: ${(property.score * 1000).toFixed(0)}`
                : '';

            card.innerHTML = `
                <img class="property-image" src="${imageUrl}" alt="${address}" loading="lazy">
                <div class="property-content">
                    <div class="property-price">${price}</div>
                    <div class="property-address">${address}</div>
                    <div class="property-location">${location}</div>
                    <div class="property-stats">
                        <div class="stat">
                            <span class="stat-icon">üõèÔ∏è</span>
                            <span>${bedrooms} beds</span>
                        </div>
                        <div class="stat">
                            <span class="stat-icon">üöø</span>
                            <span>${bathrooms} baths</span>
                        </div>
                        <div class="stat">
                            <span class="stat-icon">üìê</span>
                            <span>${sqft}</span>
                        </div>
                    </div>
                    ${score ? `<div class="property-score">${score}</div>` : ''}
                </div>
            `;

            return card;
        }

        function openPropertyModal(property) {
            currentProperty = property;
            currentImageIndex = 0;

            const address = property.address?.streetAddress || 'Property Details';
            document.getElementById('modalAddress').textContent = address;

            // Set up image gallery
            updateGalleryImage();

            // Create thumbnails
            const thumbnails = document.getElementById('thumbnails');
            thumbnails.innerHTML = '';
            if (property.images && property.images.length > 0) {
                property.images.forEach((img, index) => {
                    const thumb = document.createElement('img');
                    thumb.className = 'gallery-thumb';
                    if (index === 0) thumb.classList.add('active');
                    thumb.src = img;
                    thumb.onclick = () => {
                        currentImageIndex = index;
                        updateGalleryImage();
                    };
                    thumbnails.appendChild(thumb);
                });
            }

            // Populate details
            const detailsGrid = document.getElementById('detailsGrid');
            detailsGrid.innerHTML = `
                <div class="detail-item">
                    <div class="detail-label">Price</div>
                    <div class="detail-value">${property.price ? `$${property.price.toLocaleString()}` : 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Bedrooms</div>
                    <div class="detail-value">${property.bedrooms || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Bathrooms</div>
                    <div class="detail-value">${property.bathrooms || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Living Area</div>
                    <div class="detail-value">${property.livingArea ? `${property.livingArea.toLocaleString()} sqft` : 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Location</div>
                    <div class="detail-value">${property.address?.city || property.city || 'N/A'}, ${property.address?.state || property.state || ''}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">ZIP Code</div>
                    <div class="detail-value">${property.address?.zipcode || property.zip_code || 'N/A'}</div>
                </div>
            `;

            // Description
            const description = property.description || 'No description available.';
            document.getElementById('propertyDescription').textContent = description;

            // Initialize feedback section
            initializeFeedback(property.zpid);

            // Show modal
            document.getElementById('propertyModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('propertyModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function updateGalleryImage() {
            if (!currentProperty || !currentProperty.images || currentProperty.images.length === 0) {
                document.getElementById('galleryImage').src = 'https://via.placeholder.com/800x600?text=No+Image';
                document.getElementById('imageCounter').textContent = '0 / 0';
                return;
            }

            const images = currentProperty.images;
            document.getElementById('galleryImage').src = images[currentImageIndex];
            document.getElementById('imageCounter').textContent = `${currentImageIndex + 1} / ${images.length}`;

            // Update thumbnail active state
            const thumbs = document.querySelectorAll('.gallery-thumb');
            thumbs.forEach((thumb, index) => {
                thumb.classList.toggle('active', index === currentImageIndex);
            });
        }

        function changeImage(direction) {
            if (!currentProperty || !currentProperty.images) return;

            const totalImages = currentProperty.images.length;
            currentImageIndex = (currentImageIndex + direction + totalImages) % totalImages;
            updateGalleryImage();
        }

        // ===== FEEDBACK HANDLERS =====
        let currentFeedbackRating = null;

        function initializeFeedback(zpid) {
            // Reset feedback state
            currentFeedbackRating = null;

            // Hide all feedback sections
            document.getElementById('feedbackDetails').style.display = 'none';
            document.getElementById('feedbackSuccess').style.display = 'none';
            document.getElementById('feedbackAlreadySubmitted').style.display = 'none';

            // Reset buttons
            document.querySelectorAll('.feedback-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Reset form fields
            document.getElementById('feedbackText').value = '';
            document.getElementById('feedbackCharCount').textContent = '0';
            document.querySelectorAll('input[name="feedbackCategory"]').forEach(cb => {
                cb.checked = false;
            });

            // Check if feedback already submitted
            const submitted = Analytics.hasFeedbackBeenSubmitted(zpid);
            if (submitted) {
                document.getElementById('feedbackSection').querySelector('h3').style.display = 'none';
                document.getElementById('feedbackSection').querySelector('p').style.display = 'none';
                document.querySelector('.feedback-buttons').style.display = 'none';
                document.getElementById('feedbackAlreadySubmitted').style.display = 'flex';
            } else {
                document.getElementById('feedbackSection').querySelector('h3').style.display = 'block';
                document.getElementById('feedbackSection').querySelector('p').style.display = 'block';
                document.querySelector('.feedback-buttons').style.display = 'flex';
            }
        }

        function setFeedbackRating(rating) {
            currentFeedbackRating = rating;

            // Update button states
            document.querySelectorAll('.feedback-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            if (rating === 'up') {
                document.querySelector('.feedback-btn.thumbs-up').classList.add('selected');
                // Hide categories section for thumbs up (good match)
                document.getElementById('feedbackCategoriesSection').style.display = 'none';
            } else {
                document.querySelector('.feedback-btn.thumbs-down').classList.add('selected');
                // Show categories section for thumbs down (poor match)
                document.getElementById('feedbackCategoriesSection').style.display = 'block';
            }

            // Show feedback details section
            document.getElementById('feedbackDetails').style.display = 'block';
        }

        async function submitFeedback() {
            if (!currentFeedbackRating || !currentProperty) return;

            // Get selected categories
            const categories = Array.from(document.querySelectorAll('input[name="feedbackCategory"]:checked'))
                .map(cb => cb.value);

            // Get feedback text
            const feedbackText = document.getElementById('feedbackText').value.trim();

            // Submit to analytics
            await Analytics.submitFeedback(
                currentProperty.zpid,
                currentFeedbackRating,
                feedbackText,
                categories,
                currentProperty
            );

            // Hide form, show success message
            document.querySelector('.feedback-buttons').style.display = 'none';
            document.getElementById('feedbackDetails').style.display = 'none';
            document.getElementById('feedbackSuccess').style.display = 'flex';
        }

        function skipFeedback() {
            // Just hide the details section
            document.getElementById('feedbackDetails').style.display = 'none';
            currentFeedbackRating = null;

            // Reset button states
            document.querySelectorAll('.feedback-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        // Character counter for feedback text
        document.addEventListener('DOMContentLoaded', () => {
            const feedbackText = document.getElementById('feedbackText');
            if (feedbackText) {
                feedbackText.addEventListener('input', () => {
                    document.getElementById('feedbackCharCount').textContent = feedbackText.value.length;
                });
            }

            const bugDescription = document.getElementById('bugDescription');
            if (bugDescription) {
                bugDescription.addEventListener('input', () => {
                    document.getElementById('bugCharCount').textContent = bugDescription.value.length;
                });
            }

            const searchQualityText = document.getElementById('searchQualityText');
            if (searchQualityText) {
                searchQualityText.addEventListener('input', () => {
                    document.getElementById('searchQualityCharCount').textContent = searchQualityText.value.length;
                });
            }
        });

        // ===== SEARCH QUALITY FEEDBACK HANDLERS =====
        let currentSearchRating = null;
        let searchQualitySubmitted = false;

        function showSearchFeedbackButton() {
            const button = document.getElementById('searchFeedbackButton');
            console.log('showSearchFeedbackButton called:', {
                buttonFound: !!button,
                searchQualitySubmitted: searchQualitySubmitted,
                buttonElement: button,
                willShow: !!(button && !searchQualitySubmitted)
            });
            if (button && !searchQualitySubmitted) {
                // Immediately show, no timeout
                button.style.visibility = 'visible';
                button.style.opacity = '1';
                console.log('Search feedback button visibility set to visible, opacity to 1');
            }
        }

        function hideSearchFeedbackButton() {
            const button = document.getElementById('searchFeedbackButton');
            if (button) {
                button.style.visibility = 'hidden';
                button.style.opacity = '0';
            }
        }

        function openSearchQualityModal() {
            // Reset form
            currentSearchRating = null;
            document.querySelectorAll('.star').forEach(star => star.classList.remove('active'));
            document.getElementById('searchQualityIssues').classList.remove('visible');
            document.getElementById('searchQualityComments').style.display = 'none';
            document.getElementById('searchQualityText').value = '';
            document.getElementById('searchQualityCharCount').textContent = '0';
            document.querySelectorAll('input[name="qualityCategory"]').forEach(cb => cb.checked = false);
            document.getElementById('searchQualitySuccess').classList.remove('visible');
            document.querySelector('.search-quality-buttons').style.display = 'flex';
            document.querySelector('.star-rating').style.display = 'flex';

            // Show modal
            document.getElementById('searchQualityModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeSearchQualityModal() {
            document.getElementById('searchQualityModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function setSearchRating(rating) {
            currentSearchRating = rating;

            // Update star display
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });

            // Always show comments section
            document.getElementById('searchQualityComments').style.display = 'block';

            // Show issue categories only for ratings 1-3 (low ratings)
            const issuesSection = document.getElementById('searchQualityIssues');
            if (rating <= 3) {
                issuesSection.classList.add('visible');
            } else {
                issuesSection.classList.remove('visible');
            }
        }

        async function submitSearchQuality() {
            if (!currentSearchRating) {
                alert('Please select a rating before submitting');
                return;
            }

            // Get selected categories
            const categories = Array.from(document.querySelectorAll('input[name="qualityCategory"]:checked'))
                .map(cb => cb.value);

            // Get feedback text
            const feedbackText = document.getElementById('searchQualityText').value.trim();

            // Count properties viewed in this search
            const propertiesViewed = window.currentResults ?
                window.currentResults.filter(r => r.clickTime).length : 0;

            // Calculate time on results page
            const timeOnResults = window.searchStartTime ?
                Math.floor((Date.now() - window.searchStartTime) / 1000) : 0;

            // Submit to analytics
            const success = await Analytics.submitSearchQuality(
                currentSearchRating,
                feedbackText,
                categories,
                propertiesViewed,
                timeOnResults
            );

            if (success) {
                // Hide form, show success
                document.querySelector('.star-rating').style.display = 'none';
                document.getElementById('searchQualityIssues').classList.remove('visible');
                document.getElementById('searchQualityComments').style.display = 'none';
                document.querySelector('.search-quality-buttons').style.display = 'none';
                document.getElementById('searchQualitySuccess').classList.add('visible');

                // Mark as submitted
                searchQualitySubmitted = true;
                hideSearchFeedbackButton();

                // Close modal after delay
                setTimeout(() => {
                    closeSearchQualityModal();
                }, 2000);
            } else {
                alert('Failed to submit feedback. Please try again.');
            }
        }

        // ===== BUG REPORT HANDLERS =====
        function openBugReportModal() {
            // Reset form
            document.getElementById('bugDescription').value = '';
            document.getElementById('bugCharCount').textContent = '0';
            document.getElementById('bugReportSuccess').style.display = 'none';
            document.querySelector('input[name="issueType"][value="search_error"]').checked = true;

            // Show modal
            document.getElementById('bugReportModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeBugReportModal() {
            document.getElementById('bugReportModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        async function submitBugReport() {
            const description = document.getElementById('bugDescription').value.trim();
            if (!description) {
                alert('Please describe the issue before submitting.');
                return;
            }

            // Get selected issue type
            const issueType = document.querySelector('input[name="issueType"]:checked').value;

            // Submit to analytics
            await Analytics.reportIssue(description, issueType);

            // Show success message
            document.getElementById('bugReportSuccess').style.display = 'flex';

            // Auto-close after 2 seconds
            setTimeout(() => {
                closeBugReportModal();
            }, 2000);
        }

        // ===== SEARCH HISTORY HANDLERS =====
        function renderSearchHistory() {
            const history = Analytics.getSearchHistory();
            const container = document.getElementById('searchHistoryContainer');
            const list = document.getElementById('searchHistoryList');

            if (history.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            list.innerHTML = '';

            history.forEach((query, index) => {
                const item = document.createElement('div');
                item.className = 'search-history-item';
                item.onclick = () => rerunSearch(query);
                item.innerHTML = `
                    <span class="search-history-item-icon">üîç</span>
                    <span class="search-history-item-text">${query}</span>
                `;
                list.appendChild(item);
            });
        }

        function rerunSearch(query) {
            document.getElementById('searchQuery').value = query;
            performSearch();
        }

        function clearSearchHistory() {
            // Show custom confirmation modal instead of default alert
            document.getElementById('clearHistoryModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeClearHistoryModal() {
            document.getElementById('clearHistoryModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function confirmClearHistory() {
            Analytics.clearSearchHistory();
            renderSearchHistory();
            closeClearHistoryModal();
        }

        // Show search history when there's content in search box
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchQuery');
            if (searchInput) {
                searchInput.addEventListener('focus', () => {
                    renderSearchHistory();
                });

                // Hide history when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.search-container')) {
                        document.getElementById('searchHistoryContainer').style.display = 'none';
                    }
                });
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('propertyModal');
            if (modal.style.display === 'block') {
                if (e.key === 'ArrowLeft') changeImage(-1);
                else if (e.key === 'ArrowRight') changeImage(1);
                else if (e.key === 'Escape') closeModal();
            }
        });

        // Initialize on page load
        window.addEventListener('load', () => {
            // Initialize analytics
            Analytics.init();

            // Auto-focus search
            document.getElementById('searchQuery').focus();
        });
    </script>
</body>
</html>
