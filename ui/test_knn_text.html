<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kNN Text Similarity Test - Hearth Search</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f7f8fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .nav-menu {
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .nav-menu a {
            text-decoration: none;
            color: #006aff;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .nav-menu a:hover {
            background: #f0f0f0;
        }

        .nav-menu a.active {
            background: #006aff;
            color: white;
        }

        .header {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .test-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #555;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
        }

        textarea {
            min-height: 150px;
            resize: vertical;
        }

        .button {
            background: #f7f8fa;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .button:hover {
            transform: translateY(-2px);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .results {
            margin-top: 30px;
        }

        .result-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .result-rank {
            background: #006aff;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .result-score {
            font-size: 20px;
            font-weight: 700;
            color: #006aff;
        }

        .result-description {
            color: #333;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .result-details {
            background: white;
            padding: 15px;
            border-radius: 5px;
            font-size: 13px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #666;
        }

        .detail-value {
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box strong {
            color: #1976d2;
        }

        .similarity-bar {
            height: 20px;
            background: linear-gradient(90deg, #006aff 0%, #0056cc 100%);
            border-radius: 10px;
            margin-top: 10px;
        }

        .vector-info {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="nav-menu">
            <a href="search.html">Main Search</a>
            <a href="test_bm25.html">BM25 Test</a>
            <a href="test_knn_text.html" class="active">kNN Text Test</a>
            <a href="test_knn_image.html">kNN Image Test</a>
            <a href="admin.html">Admin Lookup</a>
            <a href="crud.html">CRUD Manager</a>
            <a href="analytics.html">Analytics Dashboard</a>
            <a href="style_detector.html">Style Detector</a>
        </nav>

        <div class="header">
            <h1>kNN Text Semantic Similarity Test</h1>
            <p class="subtitle">Test k-Nearest Neighbors semantic text similarity using AWS Bedrock embeddings on property descriptions</p>
        </div>

        <div class="test-section">
            <div class="info-box">
                <strong>About kNN Text:</strong> kNN (k-Nearest Neighbors) uses semantic embeddings to find similar text based on meaning, not just keywords. Uses AWS Bedrock amazon.titan-embed-text-v2 model to convert text into 1024-dimensional vectors, then computes cosine similarity.
            </div>

            <div class="section-title">Test Query</div>
            <div class="input-group">
                <label for="query">Search Query</label>
                <input type="text" id="query" placeholder="e.g., luxurious home with modern amenities" value="luxurious home with modern amenities">
            </div>

            <div class="section-title">Sample Property Descriptions</div>
            <div class="input-group">
                <label for="description1">Property 1 Description</label>
                <textarea id="description1" placeholder="Enter property description...">Stunning luxury estate with state-of-the-art smart home technology, gourmet chef's kitchen with professional-grade appliances, and resort-style amenities including heated pool and spa.</textarea>
            </div>

            <div class="input-group">
                <label for="description2">Property 2 Description</label>
                <textarea id="description2" placeholder="Enter property description...">Charming historic cottage with original hardwood floors, cozy fireplace, and vintage fixtures. Features traditional craftsmanship and timeless character.</textarea>
            </div>

            <div class="input-group">
                <label for="description3">Property 3 Description</label>
                <textarea id="description3" placeholder="Enter property description...">Contemporary high-end residence featuring cutting-edge automation, designer finishes, premium stainless steel appliances, and upscale spa-like bathrooms.</textarea>
            </div>

            <div class="input-group">
                <label for="description4">Property 4 Description</label>
                <textarea id="description4" placeholder="Enter property description...">Cozy starter home with basic amenities. Needs some updating but has good bones. Simple layout with functional spaces.</textarea>
            </div>

            <button class="button" onclick="runKNNTextTest()">Run kNN Text Test</button>

            <div id="results"></div>
        </div>
    </div>

    <script>
        async function runKNNTextTest() {
            const query = document.getElementById('query').value.trim();
            if (!query) {
                alert('Please enter a query');
                return;
            }

            const descriptions = [
                document.getElementById('description1').value.trim(),
                document.getElementById('description2').value.trim(),
                document.getElementById('description3').value.trim(),
                document.getElementById('description4').value.trim()
            ].filter(d => d);

            if (descriptions.length === 0) {
                alert('Please enter at least one property description');
                return;
            }

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Generating embeddings via AWS Bedrock and calculating cosine similarity...</div>';

            try {
                // Generate embedding for query
                const queryEmbedding = await generateTextEmbedding(query);

                // Generate embeddings for all descriptions and calculate similarity
                const scores = await Promise.all(descriptions.map(async (description, index) => {
                    const descEmbedding = await generateTextEmbedding(description);
                    const similarity = cosineSimilarity(queryEmbedding, descEmbedding);

                    return {
                        index: index + 1,
                        description,
                        similarity,
                        embedding: descEmbedding
                    };
                }));

                // Sort by similarity descending
                scores.sort((a, b) => b.similarity - a.similarity);

                // Display results
                let html = '<div class="results">';
                html += '<h2 class="section-title">Results (Ranked by Cosine Similarity)</h2>';

                scores.forEach((result, rank) => {
                    const normalizedScore = ((result.similarity + 1) / 2); // Convert from [-1,1] to [0,1]
                    const percentage = (normalizedScore * 100).toFixed(1);

                    html += `
                        <div class="result-card">
                            <div class="result-header">
                                <div class="result-rank">Rank #${rank + 1} (Property ${result.index})</div>
                                <div class="result-score">${result.similarity.toFixed(4)}</div>
                            </div>
                            <div class="result-description">${result.description}</div>
                            <div class="result-details">
                                <div class="detail-row">
                                    <span class="detail-label">Cosine Similarity:</span>
                                    <span class="detail-value">${result.similarity.toFixed(6)}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Normalized Score (0-1):</span>
                                    <span class="detail-value">${normalizedScore.toFixed(6)} (${percentage}%)</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Embedding Dimensions:</span>
                                    <span class="detail-value">${result.embedding.length}D vector</span>
                                </div>
                                <div style="margin-top: 10px;">
                                    <div class="detail-label">Similarity Strength:</div>
                                    <div class="similarity-bar" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                console.error('Error details:', error);
            }
        }

        async function generateTextEmbedding(text) {
            // Call AWS Bedrock via Lambda to generate embeddings
            const response = await fetch('https://bhximl74rxyigiumn5l3nyq7t40wonun.lambda-url.us-east-1.on.aws/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'embed_text',
                    text: text
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.error) {
                throw new Error(data.error);
            }

            return data.embedding;
        }

        function cosineSimilarity(vecA, vecB) {
            if (vecA.length !== vecB.length) {
                throw new Error('Vectors must have same length');
            }

            let dotProduct = 0;
            let normA = 0;
            let normB = 0;

            for (let i = 0; i < vecA.length; i++) {
                dotProduct += vecA[i] * vecB[i];
                normA += vecA[i] * vecA[i];
                normB += vecB[i] * vecB[i];
            }

            normA = Math.sqrt(normA);
            normB = Math.sqrt(normB);

            if (normA === 0 || normB === 0) {
                return 0;
            }

            return dotProduct / (normA * normB);
        }
    </script>
</body>
</html>
